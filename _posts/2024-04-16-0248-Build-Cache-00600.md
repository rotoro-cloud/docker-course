---
layout: article
---

Ок, теперь давай рассмотрим еще недоработку в моём Dockerfile. Здесь мы видим две инструкции: сначала обновление списка apt-пакетов, а далее в следующем слое установку пакета `python3-pip`.

```
FROM  ubuntu

RUN  apt-get  update  

RUN  apt-get  install  -y  python3  python3-pip

RUN  pip3  install  flask

COPY  app.py  /opt/app.py

ENTRYPOINT  FLASK_APP=/opt/app.py  flask  run  --host=0.0.0.0  --port=5000
```

```
docker  image  build  .
```

После запуска `docker build` все отработает как надо - он успешно создает образ, попутно кэшируя слои. Теперь скажем, что прошли пара месяцев, и у нас встало требование добавить в образ новый пакет, пусть это будет библиотека разработки Python.

После изменения третьей инструкции в Dockerfile (добавил `python3-dev`), кэш этого слоя стал недействительным. Но с точки зрения Docker, кэш из второй инструкции, т.е. предыдущего слоя, который запускал команду получения обновлений списков пакетов, всё ещё действителен. Поэтому, когда мы запускаем команду сборки, он повторно использует кэш из команды `apt-get update`. Основываясь на нём устанавливает Python и остальные пакеты, в том числе и нашу новую библиотеку. 

Но, поскольку список пакетов лежал в кэше, и является версией списка, актуального несколько месяцев назад, то он ничего не знает о новых версиях библиотек, на которые были обновлены репозитории apt за это время. В итоге мы получим старые версии библиотек, с которыми наше приложение может отказаться работать.
