---
layout: article
---

Для организации работы CoW-системы Docker использует разные драйвера ядра, которые умеют работать со слоистым хранением. В код Docker заложена возможность взаимодействия со многими такими бэкэндами. Нам просто стоит указать, какой из них доступен на хосте, и что мы приняли решение о его работе. Давай посмотрим, что доступно в настоящее время, и какие в них преимущества и недостатки.

Как всегда, нет `серебряной пули`, и реализация драйвера всегда является компромиссом между скоростью, надежностью, производительностью и т.д. Всегда надо выбирать под свои задачи наиболее подходящий вариант.

Самый первый критерий - это ограничение того, что поддерживает этот отдельный дистрибутив Linux. Использование драйверов, которые встроены в ядро, поставляемое вместе с дистрибутивом, всегда будет самым простым подходом. И обычно его хватает, поскольку чем проще, тем лучше. Это потому, что общий вариант обычно наиболее проверенный и по нему всегда проще получить поддержку, патчи и т.д. Но самый простой вариант может не предоставлять нужную функциональность или иметь проблемы в защите, или отдавать нам слишком мало информации о своей работе. Поэтому иногда нам приходится отходить от стандартной процедуры.

`Overlay` - файловая система, в которой несколько слоёв монтируются вместе, так что они выглядят как единая файловая система. Файловая система Overlay — наиболее рекомендуемый выбор для организации хранения в Docker, и она представлена в большинстве основных дистрибутивов. Ядра Linux < 4.0 не могут использовать этот бэкенд. Надежность и производительность системы хороши, и это стоит того, чтобы обновить ОС docker-хостов. Файловая система Overlay является частью основной (mainline) версии ядра Linux, что значит, что это очень стабильный инструмент, и что эта стабильность будет сохраняться в будущем. Docker поддерживает две версии: `overlay` и `overlay2`. Рекомендуется использовать overlay2, так как она быстрее, надежнее, а также эффективнее работает с файловыми дескрипторами.

`AuFS` - это устаревший драйвер, и он не рекомендуется для работы. Эта AuFS (продвинутая многоуровневая файловая система) когда-то это была это оригинальным бэкендом для Docker. С 24 версии уже не поддерживается, и я советую не смотреть в эту сторону. В качестве аналога рассмотри `btrfs`, о которой мы поговорим далее.

`Btrfs` - файловая система B-Tree. Представляет собой реализацию copy-on-write системы и очень хорошо подходит для модели образов Docker. Она стабильна и производительна, поэтому подходит для работы в продакшене. Может хорошо держать до тысячи контейнеров на одной и той же системе. Недостатком для систем на базе Red Hat будет то, что `btrfs` не поддерживает `SELinux`. 

Итак, если по каким-то причинам не получается с `overlay2`, но получается с `btrfs`, то это хороший вариант, рассмотри его.

`Device Mapper` был изначально написан Red Hat для поддержки своих дистрибутивов, в которых в ранние времена Docker не было AuFS. Таким образом он стал инструментом по умолчанию для всех RHEL-дистрибутивов. В зависимости от версии Red Hat Linux, это может быть единственным вариантом. Сам по себе `Device Mapper` используется давно и очень стабилен. Также на нем построено много других известных технологий. Демон Docker использует этот механизм нестандартным путём, поэтому это работает не так устойчиво, как хотелось бы. 

Если есть другие варианты, стоит отказаться от использования `devicemapper`. По умолчанию, он использует `loop-lvm`, который имеет нулевую конфигурацию. Поэтому он крайне медленный и подходит разве что для разработки. Если ты решишь использовать его в проде, убедись что ты настроил его на режим `direct-lvm`. Также имей в виду, что с 25 версии его поддержку уберут из Docker.

`VFS` - драйвер виртуальной файловой системы. Методика работы vfs является самой простой и самой медленной. Это потому, что драйвер не умеет CoW. Вместо этого он создает новый каталог и копирует туда все существующие данные. Первоначально он предназначался для использования в тестах и для монтирования томов с хоста. Драйвер vfs очень медленно создает новые контейнеры, но его производительность зависит от системы, на которой он исполняется, что является преимуществом. Поскольку его механизм очень прост, это значит, что вероятность ошибок меньше. Компания Docker не рекомендует его для промышленного использования, и тут выбор полностью твой.

`ZFS` создана Sun Microsystems и является самой продвинутой файловой системой с открытым исходным кодом, из доступных для Linux. Из-за лицензионных ограничений, она не поставляется в основной версии Linux. Однако проект `ZFS` сделал его довольно простым в установке на Linux. Docker может работать c ZFS, используя её расширенные возможности копирования при записи для реализации слоёного хранения. Учитывая, что ZFS нет в основном ядре, и она недоступна в основных коммерческих дистрибутивах, надо хорошо подумать, идя по этому пути. 

Этот проект никуда не денется, но в дальнейшем может потребовать дополнительных усилий для поддержки. С другой стороны, если ты уже используешь ZFS в производстве, не стоит от него уходить, это может быть действительно классным вариантом.

Здесь маленькое предупреждение. Если ты захочешь переключиться с одного драйвера на другой:

- будь готов к первичной просадке производительности. В начале производительность бэкенда снижается.
- после переключения бэкенда ты можешь `потерять` все образы хоста. Они не стерлись, просто новый драйвер их не видит.
